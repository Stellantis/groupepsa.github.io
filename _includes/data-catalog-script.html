<div class="notification page-disclaimer">
  <strong>Note:</strong> This is an exhaustive list of data available in Stellantis API for ex Groupe PSA brands (CitroÃ«n, DS, Peugeot, Opel and Vauxhall).
  <br> These data are a scope of possibilities, however it doesn't mean that all these data are actually available. If the feature is not part of any Connected Vehicle Service scope, then it's not currently available for use.
  <br>Be careful, data may be in different format (string, number etc.) depending on the API & version.<br>
  Filtering: you can use filters to find data in this catalog. It is possible to use multiple filters together in order to create complex filtering: 
  <ul>
    <li><em>Search:</em>  The search bar allows the filter on the name, domain, description, type, unit and value.</li>
    <li><em>Checkboxes:</em>  You can check one or multiple checkbox in order to filter data available in this API version.</li>
    <li><em>Dropdown:</em> Select the domain and type of the data you want to filter.</li>
  </ul>
</div>

<div class="data-header">
  <div class="data-count"> 
    <span style="color:#102D4F;font-size:12px;font-family:Arial, Helvetica, sans-serif">
      Showing <span id="search_count"></span> results in total <span id="total_count"></span> 
    </span>
  </div>
  <div class="table-header-search-and-reset"> 
    <div class="data-header-search field ">
      <p class="control has-icons-left">
        <input class="input" type="text" placeholder="Search in table" id="data-header-search-area" onkeyup="tablesearch(this.value)">
        <span class="icon is-small is-left">
            <i class="fas fa-search" style="color: darkgrey;"></i>
        </span>
      </p>
    </div>
    
    <button class="table-header-filter-reset" onclick="resetTabulatorFilter()">
      <span>Reset all Filters</span>
      <span class="icon ">
        <i class="fas fa-times"></i>
      </span>
    </button>
  </div>
    
  <div class="table-header-filter">

    <div class="table-header-filter-dropdown" onclick="handleFilterDropdown(this)">
      
      <span class="table-header-filter-title">
        <i class="fas fa-filter"></i>
        Filters
      </span>
      
      <span class="table-header-filter-arrow icon is-large is-white">
        <i class="fas fa-plus"></i>
        <i class="fas fa-minus"></i>
      </span>

    </div>



    
    <!-- <fieldset class="table-header-versions">
    
        <div class="table-header-api"> 
          <div class="table-header-api-title">
            <span class="tag">
              <span class="icon">
                <i class="fas fa-car-side"></i>
              </span>
              <span>
                &nbsp; WEBPORTAL
              </span>
            </span>
          </div>
          <div class="table-header-api-available"> 


            <div class="table-header-version">
              <input type="checkbox" class="api-version-checkbox" checked="true" id="webportal_v1" name="api" value="webportal_v1">
              <label>Webportal v1</label>
            </div>
            <div class="table-header-version">
              <input type="checkbox" class="api-version-checkbox" checked="true" id="webportal_v2" name="api" value="webportal_v2">
              <label>Webportal v2</label>
            </div>
          </div>            
        </div>



      <div class="table-header-api">
      
        <div class="table-header-api-title">
          <span class="tag">
            <span class="icon">
              <i class="fas fa-cloud"></i>
            </span>
            <span>
              &nbsp; WEB API
            </span>
          </span>
        </div>

        <div class="table-header-api-available">
          <div class="table-header-version">
            <input type="checkbox" class="api-version-checkbox" checked="true" id="webapi_b2b_v3" name="api" value="webapi_b2b_v3">
            <label>Web API B2B v3</label>
          </div>
          <div class="table-header-version">
            <input type="checkbox" class="api-version-checkbox" checked="true" id="webapi_b2c_v4" name="api" value="webapi_b2c_v4">
            <label>Web API B2C v4</label>
          </div>
        </div> 
      
      </div>

    </fieldset> -->

  </div>
</div>




<div id="data-catalog">
</div>

<script>
var currentSearchTerm;

function tablesearch(searchInput) {

  table.removeFilter([
      {field:"name",type:"!=",value:""},
      [
        {field:"name", type:"like", value:currentSearchTerm},
        {field:"domain", type:"like", value:currentSearchTerm},
        {field:"description", type:"like", value:currentSearchTerm}, 
        {field:"type", type:"like", value:currentSearchTerm}, 
        {field:"unit", type:"like", value:currentSearchTerm},
        {field:"enum", type:"like", value:currentSearchTerm},
      ]
  ]);

  currentSearchTerm = searchInput;

  table.addFilter([
    {field:"name",type:"!=",value:""},
    [
      {field:"name", type:"like", value:searchInput},
      {field:"domain", type:"like", value:searchInput},
      {field:"description", type:"like", value:searchInput}, 
      {field:"type", type:"like", value:searchInput}, 
      {field:"unit", type:"like", value:searchInput}, 
      {field:"value", type:"like", value:searchInput}, 
    ]
]);
}

const domain_categories = {
  alert: "fas fa-exclamation-circle",
  collision: "fas fa-car-crash",
  location: "fas fa-compass",
  maintenance: "fas fa-tools",
  monitor: "fas fa-bell",
  picture: "fas fa-image",
  remote: "fas fa-satellite-dish",
  telemetry: "fas fa-chart-bar",
  trip: "fas fa-route",
  vehicle_info: "fas fa-info",
  HMI: "fas fa-car-side",
}

const specification_page = {
  webportal: {
    v1: "/webportal/v1/api-reference/",
    v2: "/webportal/v2/api-reference/",
  },
  webapi: {
    v3: "/webapi/b2b/api-reference/references/#operation/",
    v4: "/webapi/b2c/api-reference/references/#operation/",
  }
}

function taggifyVhclType(availabilities) {
  var availabilitiesElement = 
    '<ul class="availability-api-list">';

  Object.keys(availabilities).forEach(availability => {
    availabilitiesElement = availabilitiesElement + 
      '<li>'+
        '<span class="icon">'+
          '<i class="fas ' + (availabilities[availability] ? "fa-check" : "fa-times") + '">'+
          '</i>'+
        '</span>' +
        availability +
      '</li>';
  });

  availabilitiesElement = availabilitiesElement + '</ul>'

  return availabilitiesElement;
}

function linkify(api, version, linksArray) {
  var na = "<li>"+ version + ": not available.</li>";
  if (linksArray) {
    var linksElement = "";
    var appendUrl = (api == "webportal" ? appendUrl = ".html#article" : appendUrl = "");
    linksArray.forEach(linkElement => {
      linksElement = linksElement + 
        "<li>" + 
          "<a href='{{site.baseurl}}" + specification_page[api][version] + linkElement + appendUrl +"'>"
          + (api == "webportal" ? version + ": " : "") + linkElement +
          "</a>"+
        "</li>"
    });
    return linksElement;
  }
  else return na;
}

function keyValue(type, text) {
  type = type.charAt(0).toUpperCase() + type.slice(1);
  if (Array.isArray(text)) {
    var textEnum = "[ ";
    text.forEach( (textElement, index) => {
      textEnum = textEnum  + textElement + (index == text.length - 1 ? ' ]' : ', ' )
    })
    return "<span class='data-item-subtitle'>"+ type +": </span>"+ textEnum;
  }

  else if (text) {
    return "<span class='data-item-subtitle'>"+ type +":</span> "+ text;
  }
  else return false;
}

var currentRow;

var highlightRow = function(e, row){
  var rowElement = row.getElement();
  if (rowElement == currentRow) {
    currentRow.classList.remove("data-item-highlighted");
    currentRow = null;
  }
  else {
    if (currentRow) {
      currentRow.classList.remove("data-item-highlighted");
    }
    currentRow = rowElement;
    currentRow.classList.add("data-item-highlighted");
  }
}

function listify(list) {
  var listElement = "";
  if (list) {
    list.forEach(l => {
      listElement = listElement +
        "<li>"+ l +"</li>"
      })
  } else listElement = "<span class='availability-api-na'>&nbsp;not available.</span>"
  return listElement;
}

var dataCatalogData = {{site.data.data-catalog.data | jsonify }}

var table = new Tabulator("#data-catalog", {
  data:dataCatalogData,
	movableColumns:false,
	resizableRows:false, 
  resizableColumns:false, 
  selectable:false,
  layout:"fitColumns",
  headerSort: false,
  rowClick: highlightRow,
  dataFiltered: function(filters, rows) {
    var el = document.getElementById("search_count");
    el.innerHTML = rows.length;
  },
  dataLoaded: function(data) {
    var el = document.getElementById("total_count");
    el.innerHTML = data.length;
  },
  columns:
    [
      {% unless page.subsection == "api-data" %}
      {title:"Domain", field:"domain", cssClass:"column-title", headerFilter:"select", headerFilterParams:{values: { "alert":"Alert", "collision":"Collision", "location" : "Location" , "maintenance" : "Maintenance" , "monitor": "Monitor" , "picture": "Picture", "remote":"Remote", "telemetry":"Telemetry", "trip": "Trip" , "vehicle_info": "Vehicle Info" , "HMI":"HMI"}}, headerFilterPlaceholder:"Domain"},
      {% endunless %}
      {title:"Type", field:"type", cssClass:"column-title",editor:"input", headerFilter:"select", headerFilterParams:{values: true}, headerFilterPlaceholder:"Type"},
    ],
    rowFormatter:function(row){
        var element = row.getElement(),
        data = row.getData(),
        cellContents,
        itemCategorieLogo = domain_categories[data.domain],
        elementType = data.type,
        elementEnum = keyValue("enum", data.enum),
        elementUnit = keyValue("unit", data.unit),
        elementAvailabilityVehicleTypes = taggifyVhclType(data.availability.vehicle_types),
        linksWebportalV1 = linkify("webportal", "v1", data.availability.apis.webportal_v1),
        linksWebportalV2 = linkify("webportal", "v2", data.availability.apis.webportal_v2),
        linksWebApiV4 = linkify("webapi", "v4", data.availability.apis.webapi_b2c_v4),
        linksWebApiV3 = linkify("webapi", "v3", data.availability.apis.webapi_b2b_v3),
        elementDataScope = listify(data.scope);

        //clear current row data
        while(element.firstChild) element.removeChild(element.firstChild);

        // create new row data
        cellContents = 
          "<div class='data-item-category'>"+
            "<span title='API Domain: "+ data.domain.replace("_", " ") +"' class='icon is-large'>"+
              "<i class='fa "+ itemCategorieLogo +"'></i>"+
            "</span>"+
            "<span class='data-item-domain-name'>" + data.domain.replace("vehicle_info", "Vechicle<br>Info") + "</span>"+
          "</div>"+
          "<div class='data-item-content'>"+
            "<div class='data-item-info'>"+
              "<div class='data-item-title'>" + data.name + "</div>"+
              "<div class='data-item-description'>"+ data.description +"</div>"+
            "</div>"+
            "<div class='data-item-type'>"+
              "<span class='data-item-subtitle'>Type:&nbsp;</span><span>"+ elementType + "</span>"+
            "</div>"+
            ( elementEnum ? 
            "<div class='data-item-enum'>"+
              "<span>" + elementEnum + "</span>"+
            "</div>" : "" ) +
            ( elementUnit ? 
            "<div class='data-item-unit'>"+
              "<span>" + elementUnit + "</span>"+
            "</div>" : "" ) +
            "<nav class='data-item-availability data-item-availability-vehicles'>"+
              "<span class='availability-api-title-container'>"+
                "<span class='availability-api-title'>Available Vehicles: </span>" +
              "</span>"+
                elementAvailabilityVehicleTypes +
            "</nav>"+
            "<nav class='data-item-availability data-item-availability-api data-item-availability-api-webportal'>"+
              "<span class='availability-api-title-container'>"+
                "<span class='icon'><i class='fas fa-car-side'></i></span>"+
                "<span class='availability-api-title'>" +
                  "&nbsp;Availability WebPortal:"+
                "</span>" +
              ( 
                linksWebportalV1.includes("not available.</li>")  
                && linksWebportalV2.includes("not available.</li>") ?
                "<span class='availability-api-na'>&nbsp;not available.</span></span>" :
                "</span><ul class='availability-api-list'>"+
                  linksWebportalV1 +
                  linksWebportalV2 +
                "</ul>"
              ) +
            "</nav>"+
            "<nav class='data-item-availability data-item-availability-api data-item-availability-api-webapi-v3'>"+
              "<span class='availability-api-title-container'>"+
                "<span class='icon'><i class='fas fa-cloud'></i></span>"+
                "<span class='availability-api-title'>" +
                  "&nbsp;Availability WebAPI B2B v3:"+
                "</span>" +
              ( 
                linksWebApiV3.includes("not available.</li>") ?
                "<span class='availability-api-na'>&nbsp;not available.</span></span>" :
                "</span><ul class='availability-api-list'>"+
                  linksWebApiV3 +
                "</ul>"
              ) +
            "</nav>"+
            "<nav class='data-item-availability data-item-availability-api data-item-availability-api-webapi-v4'>"+
              "<span class='availability-api-title-container'>"+
                "<span class='icon'><i class='fas fa-cloud'></i></span>"+
                "<span class='availability-api-title'>" +
                  "&nbsp;Availability WebAPI B2C v4:"+
                "</span>" +
              ( 
                linksWebApiV4.includes("not available.</li>") ?
                "<span class='availability-api-na'>&nbsp;not available.</span></span>" :
                "</span><ul class='availability-api-list'>"+
                  linksWebApiV4 +
                "</ul>"
              ) +
            "</nav>"+
            "<div class='data-item-availability data-item-availability-api'>"+
              "<span class='availability-api-title-container'>"+
                "<span class='availability-api-title'>" +
                  "&nbsp; WebAPI B2C Scopes:"+
                "</span>" +
                ( 
                  elementDataScope.includes("not available.</li>") ?
                  "<span class='availability-api-na'>&nbsp;not available.</span></span>" :
                  "</span><ul class='availability-api-list'>"+
                    elementDataScope +
                  "</ul>"
                ) +
            "</div>"+
            "<div class='non-highlighted-icon'>" +
              ( !linksWebApiV4.includes("not available.</li>") || !linksWebApiV3.includes("not available.</li>") 
                ? "<span class='icon'><i class='fas fa-cloud'></i></span>" : "<span class='icon'></span>" ) +
              ( !linksWebportalV1.includes("not available.</li>") || !linksWebportalV2.includes("not available.</li>") 
              ? "<span class='icon'><i class='fas fa-car-side'></i></span>" : "<span class='icon'></span>" ) +
            "</div>" +
          "</div>"+
          "<div class='data-item-expand-arrow'>"+
            "<span class='icon is-medium'>"+
              "<i class='fa fa-2x fa-angle-right'></i>"+
            "</span>"+
          "</div>";

        var dataItemElement = document.createElement("div");
        dataItemElement.classList.add("data-item");
        dataItemElement.innerHTML = cellContents ;

        element.append(dataItemElement);
    },
});

{% if page.subsection == "api-data" %}
table.setFilter("domain", "like", "{{page.search-catalog-keyword}}")
{% endif %}

const searchField = document.getElementById("data-header-search-area");

// ------- CHECKBOXES FILTER ---------
const checkboxesNotFiltered = {
  "webportal_v1": "-",
  "webportal_v2": "-",
  "webapi_b2b_v3": "#",
  "webapi_b2c_v4": "#"
}
var checkboxesState = {
  "webportal_v1": "-",
  "webportal_v2": "-",
  "webapi_b2b_v3": "#",
  "webapi_b2c_v4": "#"
},
currentFilter = false;

var apiFilter = {
  "webportal_v1": true,
  "webportal_v2": true,
  "webapi_b2b_v3": true,
  "webapi_b2c_v4": true
}

document.addEventListener("DOMContentLoaded",  function() {
  checkboxesElements = document.querySelectorAll(".api-version-checkbox");
  
  checkboxesElements.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      apiFilter[this.value] = this.checked;
      var newdataCatalogData = 
        dataCatalogData.filter(data =>
          (apiFilter["webportal_v1"] && data.availability.apis.webportal_v1) ||
          (apiFilter["webportal_v2"] && data.availability.apis.webportal_v2) ||
          (apiFilter["webapi_b2b_v3"] && data.availability.apis.webapi_b2b_v3) ||
          (apiFilter["webapi_b2c_v4"] && data.availability.apis.webapi_b2c_v4)
        )
        // table.replaceData(newdataCatalogData)
    });
  });

})

// ------- end CHECKBOXES FILTER ---------

function handleFilterDropdown(dropdown) {
  if (dropdown.classList.contains("table-header-filter-displayed")) {
    document.querySelector("#data-catalog.tabulator .tabulator-header").style.height = "0";
    dropdown.classList.remove("table-header-filter-displayed");
    
  }
  else  {
    document.querySelector("#data-catalog.tabulator .tabulator-header").style.height = "auto";
    dropdown.classList.add("table-header-filter-displayed");
  }
}

function resetTabulatorFilter() {
  document.querySelectorAll(".table-header-version input").forEach(e => {
    e.checked = true;
  });
  searchField.placeholder = "Search in table";
  searchField.value = null;
  table.clearFilter(true);
}

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
var search = urlParams.get('search')
var categories = urlParams.get('removed_categories');

if (search) {
  searchField.placeholder = search;
  search = search.split(",").map(function(item) {return parseInt(item, 10);});;
  table.addFilter("ID", "in", search);
}
if (categories) {
  window.addEventListener("DOMContentLoaded", function () {
      categories = categories.split(",");
      const dropdownElement = document.querySelector(".table-header-filter-dropdown");
      categories.forEach(category => {
        if (categoryElement = document.querySelector("#"+category)) {
          categoryElement.click();
        }
      });
      if (categories != false) {
        handleFilterDropdown(dropdownElement);
      }
  });
}
</script>